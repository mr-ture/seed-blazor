@page "/profile"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@attribute [Authorize]
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>Profile</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large">
    <MudText Typo="Typo.h4" Class="mb-4">User Profile</MudText>

    <MudGrid>
        <MudItem xs="12" md="4">
            <MudPaper Elevation="3" Class="pa-4">
                <MudStack Spacing="3" AlignItems="AlignItems.Center">
                    <MudAvatar Size="Size.Large" Color="Color.Primary" Style="width: 100px; height: 100px;">
                        <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Large" />
                    </MudAvatar>
                    <MudText Typo="Typo.h5">@_userName</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">@_userEmail</MudText>
                    <MudChip T="string" Color="Color.Success" Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Small">
                        Authenticated
                    </MudChip>
                </MudStack>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" md="8">
            <MudPaper Elevation="3" Class="pa-4">
                <MudText Typo="Typo.h6" Class="mb-4">User Information</MudText>
                
                <MudSimpleTable Hover="true" Dense="true">
                    <tbody>
                        <tr>
                            <td><MudText Typo="Typo.subtitle2">User ID</MudText></td>
                            <td><MudText Typo="Typo.body2">@_userId</MudText></td>
                        </tr>
                        <tr>
                            <td><MudText Typo="Typo.subtitle2">Name</MudText></td>
                            <td><MudText Typo="Typo.body2">@_userName</MudText></td>
                        </tr>
                        <tr>
                            <td><MudText Typo="Typo.subtitle2">Email</MudText></td>
                            <td><MudText Typo="Typo.body2">@_userEmail</MudText></td>
                        </tr>
                        <tr>
                            <td><MudText Typo="Typo.subtitle2">Authentication Type</MudText></td>
                            <td><MudText Typo="Typo.body2">@_authenticationType</MudText></td>
                        </tr>
                    </tbody>
                </MudSimpleTable>
            </MudPaper>

            @if (_claims.Any())
            {
                <MudPaper Elevation="3" Class="pa-4 mt-4">
                    <MudText Typo="Typo.h6" Class="mb-4">Claims</MudText>
                    
                    <MudSimpleTable Hover="true" Dense="true" Style="max-height: 400px; overflow-y: auto;">
                        <thead>
                            <tr>
                                <th><MudText Typo="Typo.subtitle2">Type</MudText></th>
                                <th><MudText Typo="Typo.subtitle2">Value</MudText></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var claim in _claims.OrderBy(c => c.Type))
                            {
                                <tr>
                                    <td><MudText Typo="Typo.caption" Color="Color.Secondary">@claim.Type</MudText></td>
                                    <td><MudText Typo="Typo.body2">@GetClaimDisplayValue(claim.Value)</MudText></td>
                                </tr>
                            }
                        </tbody>
                    </MudSimpleTable>
                </MudPaper>
            }

            @if (_hasTokens)
            {
                <MudPaper Elevation="3" Class="pa-4 mt-4">
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                        <MudText Typo="Typo.h6">Tokens</MudText>
                        <MudChip T="string" Icon="@Icons.Material.Filled.Security" Size="Size.Small" Color="Color.Info">
                            Active Session
                        </MudChip>
                    </MudStack>
                    
                    <MudList T="string" Dense="true" Class="mt-2">
                        @if (_hasAccessToken)
                        {
                            <MudListItem T="string" Icon="@Icons.Material.Filled.Key">
                                <MudText Typo="Typo.body2">Access Token</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Success">Active</MudText>
                            </MudListItem>
                        }
                        @if (_hasIdToken)
                        {
                            <MudListItem T="string" Icon="@Icons.Material.Filled.Badge">
                                <MudText Typo="Typo.body2">ID Token</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Success">Active</MudText>
                            </MudListItem>
                        }
                        @if (_hasRefreshToken)
                        {
                            <MudListItem T="string" Icon="@Icons.Material.Filled.Refresh">
                                <MudText Typo="Typo.body2">Refresh Token</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Success">Available</MudText>
                            </MudListItem>
                        }
                    </MudList>
                </MudPaper>
            }
        </MudItem>
    </MudGrid>
</MudContainer>

@code {
    private string _userName = "Unknown";
    private string _userEmail = "Not provided";
    private string _userId = "Unknown";
    private string _authenticationType = "Unknown";
    private List<Claim> _claims = new();
    private bool _hasTokens;
    private bool _hasAccessToken;
    private bool _hasIdToken;
    private bool _hasRefreshToken;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            _userName = user.FindFirst(ClaimTypes.Name)?.Value 
                ?? user.FindFirst("name")?.Value 
                ?? user.FindFirst("preferred_username")?.Value 
                ?? "Unknown";
            
            _userEmail = user.FindFirst(ClaimTypes.Email)?.Value 
                ?? user.FindFirst("email")?.Value 
                ?? "Not provided";
            
            _userId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value 
                ?? user.FindFirst("sub")?.Value 
                ?? "Unknown";
            
            _authenticationType = user.Identity.AuthenticationType ?? "Unknown";
            
            _claims = user.Claims.ToList();
            
            // Check for token claims
            _hasAccessToken = user.HasClaim(c => c.Type == "access_token");
            _hasIdToken = user.HasClaim(c => c.Type == "id_token");
            _hasRefreshToken = user.HasClaim(c => c.Type == "refresh_token");
            _hasTokens = _hasAccessToken || _hasIdToken || _hasRefreshToken;
        }
    }

    private string GetClaimDisplayValue(string value)
    {
        // Truncate long values (like tokens)
        if (value.Length > 50)
        {
            return value.Substring(0, 50) + "...";
        }
        return value;
    }
}
