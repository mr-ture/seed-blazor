@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager Navigation

<AuthorizeView>
    <Authorized>
        <MudMenu Icon="@Icons.Material.Filled.AccountCircle" Color="Color.Inherit" AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight">
            <MudMenuItem>
                <MudStack Row="false" Spacing="1">
                    <MudText Typo="Typo.subtitle2">@_userName</MudText>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">@_userEmail</MudText>
                </MudStack>
            </MudMenuItem>
            <MudDivider />
            <MudMenuItem Icon="@Icons.Material.Filled.Person" Href="/profile">Profile</MudMenuItem>
            <MudMenuItem Icon="@Icons.Material.Filled.Settings" Href="/settings">Settings</MudMenuItem>
            <MudDivider />
            <MudMenuItem Icon="@Icons.Material.Filled.Logout" IconColor="Color.Error" Href="/logout">Sign Out</MudMenuItem>
        </MudMenu>
    </Authorized>
    <NotAuthorized>
        <MudButton 
            Variant="Variant.Text" 
            Color="Color.Inherit" 
            StartIcon="@Icons.Material.Filled.Login"
            Href="/login">
            Sign In
        </MudButton>
    </NotAuthorized>
</AuthorizeView>

@code {
    private string _userName = "User";
    private string _userEmail = "";

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            _userName = user.FindFirst(ClaimTypes.Name)?.Value 
                ?? user.FindFirst("name")?.Value 
                ?? user.FindFirst("preferred_username")?.Value 
                ?? "User";
            
            _userEmail = user.FindFirst(ClaimTypes.Email)?.Value 
                ?? user.FindFirst("email")?.Value 
                ?? "";
        }
    }
}
